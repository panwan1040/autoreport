{% extends "layout.html" %}
{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">แกลเลอรีรูปภาพ</h1>
      <p class="text-gray-600">โปรเจ็กต์: {{ project }}</p>
    </div>
    <div class="flex gap-3">
      <a href="{{ url_for('index') }}" class="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all duration-200">
        <i data-feather="arrow-left" class="w-4 h-4"></i>
        กลับ
      </a>
      <a href="{{ url_for('report', project=project) }}" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 transition-all duration-200">
        <i data-feather="download" class="w-4 h-4"></i>
        ดาวน์โหลดรายงาน
      </a>
    </div>
  </div>

  <!-- Filters -->
  <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
      <i data-feather="filter" class="w-5 h-5 text-blue-600"></i>
      ตัวกรอง
    </h3>
    <div class="grid md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">จุด (Point)</label>
        <select id="pointFilter" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
          <option value="">ทุกจุด</option>
          {% set points = items | map(attribute='point') | unique | list %}
          {% for point in points | sort %}
            <option value="{{ point }}">{{ point }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">ขั้นตอน (Step)</label>
        <select id="stepFilter" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
          <option value="">ทุกขั้นตอน</option>
          {% set steps = items | map(attribute='step') | unique | list %}
          {% for step in steps | sort %}
            <option value="{{ step }}">{{ step_labels.get(step, step) }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">เรียงลำดับ</label>
        <select id="sortFilter" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
          <option value="date-desc">วันที่ใหม่สุด</option>
          <option value="date-asc">วันที่เก่าสุด</option>
          <option value="name-asc">ชื่อไฟล์ A-Z</option>
          <option value="name-desc">ชื่อไฟล์ Z-A</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Gallery -->
  <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold flex items-center gap-2">
        <i data-feather="image" class="w-5 h-5 text-green-600"></i>
        รูปภาพทั้งหมด
      </h3>
      <div class="text-sm text-gray-500">
        <span id="imageCount">{{ items | length }}</span> รูป
      </div>
    </div>
    
      <div id="gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      {% for it in items %}
        <div class="gallery-item file-item bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden hover:shadow-lg transition-all duration-300"
             data-id="{{ it.id }}"
             data-point="{{ it.point }}"
             data-step="{{ it.step }}"
             data-filename="{{ it.filename }}"
             data-date="{{ it.uploaded_at }}">
          <div class="relative group">
            <img class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105"
                 src="{{ it.url }}"
                 alt="{{ it.filename }}"
                 loading="lazy" />
            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-300 flex items-center justify-center">
              <button class="opacity-0 group-hover:opacity-100 bg-white bg-opacity-90 p-2 rounded-full transition-all duration-300 transform scale-75 group-hover:scale-100"
                      onclick="openImageModal('{{ it.url }}', '{{ it.filename }}')">
                <i data-feather="maximize-2" class="w-5 h-5 text-gray-700"></i>
              </button>
            </div>
            <button class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 bg-white bg-opacity-90 p-1 rounded-full transition-all duration-300"
                    onclick="deletePhoto({{ it.id }}, this)">
              <i data-feather="trash-2" class="w-4 h-4 text-red-600"></i>
            </button>
          </div>
          <div class="p-4">
            <div class="flex items-center gap-2 mb-2">
              <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium">
                จุด {{ it.point }}
              </span>
              <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">
                ขั้นตอน {{ it.step }}
              </span>
            </div>
            <div class="text-sm text-gray-600 mb-2">
              <div class="font-medium text-gray-800 truncate">{{ it.filename }}</div>
              <div class="text-xs text-gray-500">{{ it.uploaded_at }}</div>
            </div>
            <div class="text-xs text-gray-500">
              {{ step_labels.get(it.step, it.step) }}
            </div>
          </div>
        </div>
      {% endfor %}
      </div>
    
    <div id="noResults" class="hidden text-center py-12">
      <i data-feather="image" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
      <p class="text-gray-500">ไม่พบรูปภาพที่ตรงกับเงื่อนไข</p>
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
  <div class="relative max-w-4xl max-h-full">
    <button onclick="closeImageModal()" class="absolute top-4 right-4 bg-white bg-opacity-90 p-2 rounded-full hover:bg-opacity-100 transition-all duration-200 z-10">
      <i data-feather="x" class="w-6 h-6 text-gray-700"></i>
    </button>
    <img id="modalImage" class="max-w-full max-h-full object-contain rounded-lg" src="" alt="" />
    <div class="absolute bottom-4 left-4 bg-black bg-opacity-75 text-white px-4 py-2 rounded-lg">
      <div id="modalFilename" class="font-medium"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const pointFilter = document.getElementById('pointFilter');
  const stepFilter = document.getElementById('stepFilter');
  const sortFilter = document.getElementById('sortFilter');
  const gallery = document.getElementById('gallery');
  const noResults = document.getElementById('noResults');
  const imageCount = document.getElementById('imageCount');

  function filterGallery() {
    const selectedPoint = pointFilter.value;
    const selectedStep = stepFilter.value;
    const selectedSort = sortFilter.value;

    let visibleItems = 0;
    const items = document.querySelectorAll('.gallery-item');
    const itemArray = Array.from(items);

    // Filter items
    itemArray.forEach(item => {
      const point = item.dataset.point;
      const step = item.dataset.step;
      
      const pointMatch = !selectedPoint || point === selectedPoint;
      const stepMatch = !selectedStep || step === selectedStep;
      
      if (pointMatch && stepMatch) {
        item.style.display = 'block';
        visibleItems++;
      } else {
        item.style.display = 'none';
      }
    });

    // Sort items
    itemArray.sort((a, b) => {
      switch(selectedSort) {
        case 'date-desc':
          return new Date(b.dataset.date) - new Date(a.dataset.date);
        case 'date-asc':
          return new Date(a.dataset.date) - new Date(b.dataset.date);
        case 'name-asc':
          return a.dataset.filename.localeCompare(b.dataset.filename);
        case 'name-desc':
          return b.dataset.filename.localeCompare(a.dataset.filename);
        default:
          return 0;
      }
    });

    // Reorder items in DOM
    itemArray.forEach(item => {
      gallery.appendChild(item);
    });

    // Update count and show/hide no results
    imageCount.textContent = visibleItems;
    if (visibleItems === 0) {
      noResults.classList.remove('hidden');
    } else {
      noResults.classList.add('hidden');
    }
  }

  // Add event listeners
  pointFilter.addEventListener('change', filterGallery);
  stepFilter.addEventListener('change', filterGallery);
  sortFilter.addEventListener('change', filterGallery);

  // Initialize filters
  filterGallery();
});

// Image modal functions
function openImageModal(src, filename) {
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  const modalFilename = document.getElementById('modalFilename');
  
  modalImage.src = src;
  modalFilename.textContent = filename;
  modal.classList.remove('hidden');
  
  // Prevent body scroll
  document.body.style.overflow = 'hidden';
}

function closeImageModal() {
  const modal = document.getElementById('imageModal');
  modal.classList.add('hidden');
  
  // Restore body scroll
  document.body.style.overflow = 'auto';
}

// Close modal on background click
document.getElementById('imageModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeImageModal();
  }
});

// Close modal on escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeImageModal();
  }
});

function deletePhoto(id, btn) {
  if (!confirm('ต้องการลบรูปนี้หรือไม่?')) return;
  fetch(`/delete_photo/${id}`, {method: 'POST'})
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        const item = btn.closest('.gallery-item');
        item.remove();
        filterGallery();
      } else {
        alert(data.message || 'เกิดข้อผิดพลาดในการลบ');
      }
    })
    .catch(() => alert('เกิดข้อผิดพลาดในการลบ'));
}
</script>
{% endblock %}
