{% extends "layout.html" %}
{% block content %}
<div class="grid lg:grid-cols-2 gap-8">
  <!-- สร้างโปรเจ็กต์ใหม่ -->
  <section class="slide-in p-6 bg-white rounded-xl shadow-lg border border-gray-100">
    <div class="flex items-center gap-3 mb-4">
      <div class="p-2 bg-blue-100 rounded-lg">
        <i data-feather="plus-circle" class="w-6 h-6 text-blue-600"></i>
      </div>
      <h2 class="text-xl font-semibold text-gray-800">สร้างโปรเจ็กต์ใหม่</h2>
    </div>
    <form method="post" action="{{ url_for('create_project') }}" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">ชื่อโปรเจ็กต์</label>
        <input type="text" name="project_name" 
               class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" 
               placeholder="เช่น อาคาร 4 โครงสร้างชั้น 3" />
      </div>
      <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-lg font-medium hover:from-blue-700 hover:to-blue-800 transition-all duration-200 transform hover:scale-105 flex items-center justify-center gap-2">
        <i data-feather="plus" class="w-5 h-5"></i>
        สร้างโปรเจ็กต์
      </button>
    </form>
  </section>

  <!-- อัปโหลดรูป -->
  <section class="slide-in p-6 bg-white rounded-xl shadow-lg border border-gray-100">
    <div class="flex items-center gap-3 mb-4">
      <div class="p-2 bg-green-100 rounded-lg">
        <i data-feather="upload" class="w-6 h-6 text-green-600"></i>
      </div>
      <h2 class="text-xl font-semibold text-gray-800">อัปโหลดรูป</h2>
    </div>
    
    <form method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data" class="space-y-4" id="uploadForm">
      <!-- เลือกโปรเจ็กต์ -->
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">เลือกโปรเจ็กต์ที่มี</label>
          <select name="project_select" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
            <option value="">-- เลือกโปรเจ็กต์ --</option>
            {% for p in projects %}
              <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">หรือระบุโปรเจ็กต์ใหม่</label>
          <input name="project_manual" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" placeholder="พิมพ์ชื่อโปรเจ็กต์"/>
        </div>
      </div>
      
      <!-- จุดและขั้นตอน -->
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">จุด (Point)</label>
          <input name="point" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" placeholder="เช่น 1, 2, คาน-01"/>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ขั้นตอน (Step)</label>
          <select name="step" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
            <option value="">-- เลือกขั้นตอน --</option>
            {% for code, name in step_labels.items() %}
              <option value="{{ code }}">{{ name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      
      <!-- Drag & Drop Area -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">เลือกรูปภาพ</label>
        <div class="drag-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center transition-all duration-300" id="dragArea">
          <div class="space-y-4">
            <i data-feather="image" class="w-12 h-12 text-gray-400 mx-auto"></i>
            <div>
              <p class="text-lg font-medium text-gray-700">ลากวางไฟล์รูปภาพที่นี่</p>
              <p class="text-sm text-gray-500 mt-1">หรือคลิกเพื่อเลือกไฟล์</p>
            </div>
            <input type="file" name="photos" accept="image/*" multiple class="hidden" id="fileInput"/>
            <button type="button" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-all duration-200" onclick="document.getElementById('fileInput').click()">
              เลือกไฟล์
            </button>
          </div>
        </div>
        
        <!-- File Preview -->
        <div id="filePreview" class="mt-4 space-y-2 hidden">
          <h4 class="text-sm font-medium text-gray-700">ไฟล์ที่เลือก:</h4>
          <div id="fileList" class="space-y-2"></div>
        </div>
      </div>
      
      <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-lg font-medium hover:from-green-700 hover:to-green-800 transition-all duration-200 transform hover:scale-105 flex items-center justify-center gap-2">
        <i data-feather="upload" class="w-5 h-5"></i>
        อัปโหลดรูป
      </button>
    </form>
  </section>
</div>

<!-- สร้างรายงาน -->
<section class="slide-in p-6 bg-white rounded-xl shadow-lg border border-gray-100 mt-8">
  <div class="flex items-center gap-3 mb-4">
    <div class="p-2 bg-purple-100 rounded-lg">
      <i data-feather="file-text" class="w-6 h-6 text-purple-600"></i>
    </div>
    <h2 class="text-xl font-semibold text-gray-800">สร้างรายงาน Word</h2>
  </div>
  
  <div class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">เลือกโปรเจ็กต์</label>
      <input name="project" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" list="projlist" placeholder="พิมพ์ชื่อโปรเจ็กต์" id="reportProject"/>
      <datalist id="projlist">
        {% for p in projects %}
          <option value="{{ p }}"></option>
        {% endfor %}
      </datalist>
    </div>
    
    <div class="flex flex-wrap gap-3">
      <button id="report_link" class="flex items-center gap-2 bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-lg font-medium hover:from-green-700 hover:to-green-800 transition-all duration-200 transform hover:scale-105">
        <i data-feather="download" class="w-5 h-5"></i>
        ดาวน์โหลด .docx
      </button>
      <button id="browse_link" class="flex items-center gap-2 bg-gradient-to-r from-gray-600 to-gray-700 text-white px-6 py-3 rounded-lg font-medium hover:from-gray-700 hover:to-gray-800 transition-all duration-200 transform hover:scale-105">
        <i data-feather="image" class="w-5 h-5"></i>
        ดูแกลเลอรี
      </button>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const dragArea = document.getElementById('dragArea');
  const fileInput = document.getElementById('fileInput');
  const filePreview = document.getElementById('filePreview');
  const fileList = document.getElementById('fileList');
  const reportLink = document.getElementById('report_link');
  const browseLink = document.getElementById('browse_link');
  const reportProject = document.getElementById('reportProject');

  // Drag and Drop functionality
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dragArea.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    dragArea.addEventListener(eventName, highlight, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dragArea.addEventListener(eventName, unhighlight, false);
  });

  function highlight(e) {
    dragArea.classList.add('dragover');
  }

  function unhighlight(e) {
    dragArea.classList.remove('dragover');
  }

  dragArea.addEventListener('drop', handleDrop, false);
  fileInput.addEventListener('change', handleFiles);

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles({ target: { files: files } });
  }

  function handleFiles(e) {
    const files = [...e.target.files];
    updateFilePreview(files);
  }

  function updateFilePreview(files) {
    fileList.innerHTML = '';
    
    if (files.length > 0) {
      filePreview.classList.remove('hidden');
      
      files.forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200';
        
        const icon = document.createElement('i');
        icon.setAttribute('data-feather', 'image');
        icon.className = 'w-5 h-5 text-blue-600';
        
        const fileInfo = document.createElement('div');
        fileInfo.className = 'flex-1';
        fileInfo.innerHTML = `
          <div class="font-medium text-gray-800">${file.name}</div>
          <div class="text-sm text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
        `;
        
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'text-red-500 hover:text-red-700 transition-colors duration-200';
        removeBtn.innerHTML = '<i data-feather="x" class="w-4 h-4"></i>';
        removeBtn.onclick = () => {
          fileItem.remove();
          if (fileList.children.length === 0) {
            filePreview.classList.add('hidden');
          }
        };
        
        fileItem.appendChild(icon);
        fileItem.appendChild(fileInfo);
        fileItem.appendChild(removeBtn);
        fileList.appendChild(fileItem);
      });
      
      feather.replace();
    } else {
      filePreview.classList.add('hidden');
    }
  }

  // Report and Browse functionality
  function getProjectName() {
    return reportProject.value.trim();
  }

  function validateProject() {
    const project = getProjectName();
    if (!project) {
      alert('โปรดระบุชื่อโปรเจ็กต์');
      return false;
    }
    return true;
  }

  reportLink.addEventListener('click', function(e) {
    e.preventDefault();
    if (validateProject()) {
      const project = getProjectName();
      window.location.href = '/report/' + encodeURIComponent(project);
    }
  });

  browseLink.addEventListener('click', function(e) {
    e.preventDefault();
    if (validateProject()) {
      const project = getProjectName();
      window.location.href = '/browse/' + encodeURIComponent(project);
    }
  });

  // AJAX Upload functionality
  const uploadForm = document.getElementById('uploadForm');
  uploadForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const projectSelect = document.querySelector('select[name="project_select"]');
    const projectManual = document.querySelector('input[name="project_manual"]');
    const point = document.querySelector('input[name="point"]');
    const step = document.querySelector('select[name="step"]');
    const fileInput = document.getElementById('fileInput');
    
    // Get project name
    const project = projectSelect.value || projectManual.value;
    if (!project) {
      alert('โปรดเลือกหรือระบุโปรเจ็กต์');
      return;
    }
    
    if (!point.value || !step.value) {
      alert('โปรดระบุจุดและขั้นตอน');
      return;
    }
    
    if (fileInput.files.length === 0) {
      alert('โปรดเลือกรูปภาพ');
      return;
    }
    
    // Add form data
    formData.append('project', project);
    formData.append('point', point.value);
    formData.append('step', step.value);
    
    for (let file of fileInput.files) {
      formData.append('photos', file);
    }
    
    // Show loading state
    const submitBtn = uploadForm.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i data-feather="loader" class="w-5 h-5 animate-spin"></i> อัปโหลด...';
    submitBtn.disabled = true;
    feather.replace();
    
    // Send AJAX request
    fetch('/upload_ajax', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Show success message
        const successDiv = document.createElement('div');
        successDiv.className = 'fade-in p-4 rounded-lg bg-green-50 text-green-800 border-l-4 border-green-400 mb-4';
        successDiv.innerHTML = `
          <div class="flex items-center gap-2">
            <i data-feather="check-circle" class="w-5 h-5"></i>
            ${data.message}
          </div>
        `;
        uploadForm.parentNode.insertBefore(successDiv, uploadForm);
        feather.replace();
        
        // Reset form
        uploadForm.reset();
        filePreview.classList.add('hidden');
        fileList.innerHTML = '';
        
        // Remove success message after 5 seconds
        setTimeout(() => {
          successDiv.remove();
        }, 5000);
        
        // Reload page to update project list
        setTimeout(() => {
          window.location.reload();
        }, 2000);
      } else {
        // Show error message
        const errorDiv = document.createElement('div');
        errorDiv.className = 'fade-in p-4 rounded-lg bg-red-50 text-red-800 border-l-4 border-red-400 mb-4';
        errorDiv.innerHTML = `
          <div class="flex items-center gap-2">
            <i data-feather="x-circle" class="w-5 h-5"></i>
            ${data.message}
          </div>
        `;
        uploadForm.parentNode.insertBefore(errorDiv, uploadForm);
        feather.replace();
        
        // Remove error message after 5 seconds
        setTimeout(() => {
          errorDiv.remove();
        }, 5000);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'fade-in p-4 rounded-lg bg-red-50 text-red-800 border-l-4 border-red-400 mb-4';
      errorDiv.innerHTML = `
        <div class="flex items-center gap-2">
          <i data-feather="x-circle" class="w-5 h-5"></i>
          เกิดข้อผิดพลาดในการอัปโหลด
        </div>
      `;
      uploadForm.parentNode.insertBefore(errorDiv, uploadForm);
      feather.replace();
      
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    })
    .finally(() => {
      // Restore button state
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
      feather.replace();
    });
  });

  // Add animation to sections
  const sections = document.querySelectorAll('.slide-in');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.opacity = '1';
        entry.target.style.transform = 'translateX(0)';
      }
    });
  });

  sections.forEach(section => {
    section.style.opacity = '0';
    section.style.transform = 'translateX(-20px)';
    section.style.transition = 'all 0.6s ease-out';
    observer.observe(section);
  });
});
</script>
{% endblock %}
